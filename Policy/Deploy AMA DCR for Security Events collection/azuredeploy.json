{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {},
    "functions": [],
    "variables": {
        "dcrPolicyDefinitionName": "DeployDCRForSecurityEvents",
        "dcrPolicyDefinitionDisplayName": "Deploy Data Collection Rule and Associations for Security Events collection for existing Virtual Machines",
        "dcrPolicyDefinitionDescription": "This policy definition ensures that all existing Windows Machines are associated to a new Data Collection Rule to collect Security Events into a specific Log Analytics workspace",
        "dcraPolicyDefinitionName": "DeployDCRAssociationForSecurityEvents",
        "dcraPolicyDefinitionDisplayName": "Deploy Data Collection Rule Association for Security Events collection for new Virtual Machines",
        "dcraPolicyDefinitionDescription": "This policy definition ensures that all new Windows Machines are associated to the existing Data Collection Rule to collect Security Events into a specific Log Analytics workspace",
        "policySetName": "DeployAMADCRForSecurityEvents",
        "policySetDisplayName": "Configure Data Collection Rule for Security Events collection",
        "policySetDescription": "This policy initiative ensures that all Windows Machines are associated to a Data Collection Rule to collect Security Events into a specific Log Analytics workspace"
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2021-06-01",
            "name": "[variables('dcrPolicyDefinitionName')]",
            "properties": {
                "policyType": "Custom",
                "mode": "Indexed",
                "displayName": "[variables('dcrPolicyDefinitionDisplayName')]",
                "description": "[variables('dcrPolicyDefinitionDescription')]",
                "metadata": {
                    "category": "Security Center"
                },
                "parameters": {
                    "effect": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Effect",
                            "description": "Enable or disable the execution of the policy"
                        },
                        "allowedValues": [
                            "DeployIfNotExists",
                            "Disabled"
                        ],
                        "defaultValue": "DeployIfNotExists"
                    },
                    "userWorkspaceResourceId": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Workspace Resource Id",
                            "description": "Select the Log Analytics workspace to which the virtual machines in scope will send their logs. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                            "strongType": "omsWorkspace"
                        }
                    },
                    "dcrRegion": {
                        "type": "String",
                        "metadata": {
                            "displayName": "DCR region",
                            "description": "Region from which the virtual machines in scope will send their logs. Needed to create the Data Collection Rule in the same region",
                            "strongType": "location"
                        }
                    },
                    "dcrResourceGroup": {
                        "type": "String",
                        "metadata": {
                            "displayName": "DCR Resource Group",
                            "description": "Resource Group for the Security Events Data Collection Rule"
                        }
                    },
                    "eventFilter": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Security Events Filter",
                            "description": "Security Events Filter (all events, common, minimal, or custom)"
                        },
                        "allowedValues": [ "AllEvents", "Common", "Minimal", "Custom" ]
                    },
                    "listOfCustomEventFilters": {
                        "type": "Array",
                        "metadata": {
                            "displayName": "Custom xPath Queries",
                            "description": "List of xPath queries to filter the Security Events. Example values: 'Security!*[System[(EventID=4624 or EventID=4625)]]'"
                        },
                        "defaultValue": []
                    },
                    "listOfWindowsImageIdToInclude": {
                        "type": "Array",
                        "metadata": {
                            "displayName": "Additional Virtual Machine Images",
                            "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
                        },
                        "defaultValue": []
                    }
                },
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Compute/virtualMachines"
                            },
                            {
                                "field": "location",
                                "in": [
                                    "australiacentral",
                                    "australiaeast",
                                    "australiasoutheast",
                                    "brazilsouth",
                                    "canadacentral",
                                    "canadaeast",
                                    "centralindia",
                                    "centralus",
                                    "eastasia",
                                    "eastus2euap",
                                    "eastus",
                                    "eastus2",
                                    "francecentral",
                                    "germanywestcentral",
                                    "japaneast",
                                    "japanwest",
                                    "jioindiawest",
                                    "koreacentral",
                                    "koreasouth",
                                    "northcentralus",
                                    "northeurope",
                                    "norwayeast",
                                    "southafricanorth",
                                    "southcentralus",
                                    "southeastasia",
                                    "southindia",
                                    "switzerlandnorth",
                                    "uaenorth",
                                    "uksouth",
                                    "ukwest",
                                    "westcentralus",
                                    "westeurope",
                                    "westindia",
                                    "westus",
                                    "westus2"
                                ]
                            },
                            {
                                "anyOf": [
                                    {
                                        "field": "Microsoft.Compute/imageId",
                                        "in": "[[parameters('listOfWindowsImageIdToInclude')]"
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsServer"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "WindowsServer"
                                            },
                                            {
                                                "anyOf": [
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2008-R2-SP1*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2012-*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2016-*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2019-*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2022-*"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsServer"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "WindowsServerSemiAnnual"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageSKU",
                                                "in": [
                                                    "Datacenter-Core-1709-smalldisk",
                                                    "Datacenter-Core-1709-with-Containers-smalldisk",
                                                    "Datacenter-Core-1803-with-Containers-smalldisk"
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsServerHPCPack"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "WindowsServerHPCPack"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftSQLServer"
                                            },
                                            {
                                                "anyOf": [
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2022"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2022-BYOL"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2019"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2019-BYOL"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2016"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2016-BYOL"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2012R2"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2012R2-BYOL"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftRServer"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "MLServer-WS2016"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftVisualStudio"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "in": [
                                                    "VisualStudio",
                                                    "Windows"
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftDynamicsAX"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "Dynamics"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageSKU",
                                                "equals": "Pre-Req-AX7-Onebox-U8"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "microsoft-ads"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "windows-data-science-vm"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsDesktop"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "Windows-10"
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    "then": {
                        "effect": "[[parameters('effect')]",
                        "details": {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "deploymentScope": "subscription",
                            "roleDefinitionIds": [
                                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                            ],
                            "existenceScope": "subscription",
                            "existenceCondition": {
                                "allOf": [
                                    {
                                        "field": "location",
                                        "equals": "[[parameters('dcrRegion')]"
                                    },
                                    {
                                        "field": "name",
                                        "equals": "[[concat('Microsoft-SecurityEvents-', parameters('dcrRegion'), '-dcr')]"
                                    }
                                ]
                            },
                            "deployment": {
                                "location": "westeurope",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {
                                        "resourceGroup": {
                                            "value": "[[resourceGroup().name]"
                                        },
                                        "vmName": {
                                            "value": "[[field('name')]"
                                        },
                                        "userWorkspaceResourceId": {
                                            "value": "[[parameters('userWorkspaceResourceId')]"
                                        },
                                        "dcrRegion": {
                                            "value": "[[parameters('dcrRegion')]"
                                        },
                                        "dcrResourceGroup": {
                                            "value": "[[parameters('dcrResourceGroup')]"
                                        },
                                        "eventFilter": {
                                            "value": "[[parameters('eventFilter')]"
                                        },
                                        "listOfCustomEventFilters": {
                                            "value": "[[parameters('listOfCustomEventFilters')]"
                                        }
                                    },
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "resourceGroup": {
                                                "type": "string"
                                            },
                                            "vmName": {
                                                "type": "string"
                                            },
                                            "userWorkspaceResourceId": {
                                                "type": "string"
                                            },
                                            "dcrRegion": {
                                                "type": "string"
                                            },
                                            "dcrResourceGroup": {
                                                "type": "string"
                                            },
                                            "eventFilter": {
                                                "type": "string"
                                            },
                                            "listOfCustomEventFilters": {
                                                "type": "array"
                                            }
                                        },
                                        "variables": {
                                            "subscriptionId": "[[subscription().subscriptionId]",
                                            "workspaceResourceId": "[[parameters('userWorkspaceResourceId')]",
                                            "dcrName": "[[concat('Microsoft-SecurityEvents-', parameters('dcrRegion'), '-dcr')]",
                                            "dcrId": "[[concat('/subscriptions/', variables('subscriptionId'), '/resourceGroups/', parameters('dcrResourceGroup'), '/providers/Microsoft.Insights/dataCollectionRules/', variables('dcrName'))]",
                                            "dcraName": "[[concat(parameters('vmName'),'/Microsoft.Insights/SecurityEvents-RulesAssociation')]",
                                            "deployDefaultAmaDcrResourceGroup": "[[concat('deployDefaultAmaDcrResourceGroup-', uniqueString(deployment().name))]",
                                            "deployDataCollectionRulesAssociation": "[[concat('deployDataCollectionRulesAssociation-', uniqueString(deployment().name))]",
                                            "xPathQueries": {
                                                "AllEvents": [ "Security!*", "Microsoft-Windows-AppLocker/EXE and DLL!*", "Microsoft-Windows-AppLocker/MSI and Script!*" ],
                                                "Common": [ "Security!*[System[(EventID=4624 or EventID=4625)]]", "Security!*[System[(EventID=4648 or EventID=4649)]]", "Security!*[System[(EventID=4672 or EventID=4673)]]", "Security!*[System[(EventID=4688 or EventID=4689)]]", "Security!*[System[(EventID=4697 or EventID=4698)]]", "Security!*[System[(EventID=4720 or EventID=4722)]]", "Security!*[System[(EventID=4723 or EventID=4724)]]", "Security!*[System[(EventID=4725 or EventID=4726)]]", "Security!*[System[(EventID=4732 or EventID=4733)]]", "Security!*[System[(EventID=4738 or EventID=4739)]]", "Security!*[System[(EventID=4740 or EventID=4741)]]", "Security!*[System[(EventID=4742 or EventID=4743)]]", "Security!*[System[(EventID=4746 or EventID=4747)]]", "Security!*[System[(EventID=4756 or EventID=4757)]]", "Security!*[System[(EventID=4767 or EventID=4768)]]", "Security!*[System[(EventID=4776 or EventID=4778)]]", "Security!*[System[(EventID=4779 or EventID=4780)]]", "Security!*[System[(EventID=4798 or EventID=4799)]]", "Security!*[System[(EventID=4800 or EventID=4801)]]", "Security!*[System[(EventID=4802 or EventID=4803)]]", "Security!*[System[(EventID=4808 or EventID=4809)]]", "Security!*[System[(EventID=4816 or EventID=4817)]]", "Security!*[System[(EventID=4826 or EventID=4827)]]", "Security!*[System[(EventID=4904 or EventID=4905)]]", "Security!*[System[(EventID=4906 or EventID=4907)]]" ],
                                                "Minimal": [ "Security!*[System[(EventID=4624 or EventID=4625)]]", "Security!*[System[(EventID=4648 or EventID=4649)]]", "Security!*[System[(EventID=4672 or EventID=4673)]]", "Security!*[System[(EventID=4688 or EventID=4689)]]", "Security!*[System[(EventID=4697 or EventID=4698)]]", "Security!*[System[(EventID=4720 or EventID=4722)]]", "Security!*[System[(EventID=4723 or EventID=4724)]]", "Security!*[System[(EventID=4725 or EventID=4726)]]", "Security!*[System[(EventID=4732 or EventID=4733)]]", "Security!*[System[(EventID=4738 or EventID=4739)]]", "Security!*[System[(EventID=4740 or EventID=4741)]]", "Security!*[System[(EventID=4742 or EventID=4743)]]", "Security!*[System[(EventID=4746 or EventID=4747)]]", "Security!*[System[(EventID=4756 or EventID=4757)]]", "Security!*[System[(EventID=4767 or EventID=4768)]]", "Security!*[System[(EventID=4776 or EventID=4778)]]", "Security!*[System[(EventID=4779 or EventID=4780)]]", "Security!*[System[(EventID=4798 or EventID=4799)]]", "Security!*[System[(EventID=4800 or EventID=4801)]]", "Security!*[System[(EventID=4802 or EventID=4803)]]", "Security!*[System[(EventID=4808 or EventID=4809)]]", "Security!*[System[(EventID=4816 or EventID=4817)]]", "Security!*[System[(EventID=4826 or EventID=4827)]]", "Security!*[System[(EventID=4904 or EventID=4905)]]", "Security!*[System[(EventID=4906 or EventID=4907)]]" ]
                                            }
                                        },
                                        "resources": [
                                            {
                                                "type": "Microsoft.Resources/resourceGroups",
                                                "name": "[[parameters('dcrResourceGroup')]",
                                                "apiVersion": "2019-05-01",
                                                "location": "[[parameters('dcrRegion')]"
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "name": "[[variables('deployDefaultAmaDcrResourceGroup')]",
                                                "apiVersion": "2020-06-01",
                                                "resourceGroup": "[[parameters('dcrResourceGroup')]",
                                                "properties": {
                                                    "mode": "Incremental",
                                                    "expressionEvaluationOptions": {
                                                        "scope": "inner"
                                                    },
                                                    "parameters": {
                                                        "dcrRegion": {
                                                            "value": "[[parameters('dcrRegion')]"
                                                        },
                                                        "workspaceResourceId": {
                                                            "value": "[[variables('workspaceResourceId')]"
                                                        },
                                                        "dcrName": {
                                                            "value": "[[variables('dcrName')]"
                                                        },
                                                        "dcrId": {
                                                            "value": "[[variables('dcrId')]"
                                                        },
                                                        "xPathQueries": {
                                                            "value": "[[if(equals(parameters('eventFilter'),'AllEvents'),variables('xpathQueries').AllEvents,if(equals(parameters('eventFilter'),'Common'),variables('xpathQueries').Common,if(equals(parameters('eventFilter'),'Minimal'),variables('xpathQueries').Minimal,parameters('listOfCustomEventFilters'))))]"
                                                        }
                                                    },
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {
                                                            "dcrRegion": {
                                                                "type": "string"
                                                            },
                                                            "workspaceResourceId": {
                                                                "type": "string"
                                                            },
                                                            "dcrName": {
                                                                "type": "string"
                                                            },
                                                            "dcrId": {
                                                                "type": "string"
                                                            },
                                                            "xPathQueries": {
                                                                "type": "array"
                                                            }
                                                        },
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "type": "Microsoft.Insights/dataCollectionRules",
                                                                "name": "[[parameters('dcrName')]",
                                                                "apiVersion": "2021-04-01",
                                                                "location": "[[parameters('dcrRegion')]",
                                                                "properties": {
                                                                    "description": "Data collection rule for Microsoft Defender for Cloud. Deleting this rule will break the detection of security vulnerabilities.",
                                                                    "dataSources": {
                                                                        "windowsEventLogs": [
                                                                            {
                                                                                "streams": [
                                                                                    "Microsoft-SecurityEvent"
                                                                                ],
                                                                                "xPathQueries": "[[parameters('xPathQueries')]",
                                                                                "name": "eventLogsDataSource"
                                                                            }
                                                                        ]
                                                                    },
                                                                    "destinations": {
                                                                        "logAnalytics": [
                                                                            {
                                                                                "workspaceResourceId": "[[parameters('workspaceResourceId')]",
                                                                                "name": "DataCollectionEvent"
                                                                            }
                                                                        ]
                                                                    },
                                                                    "dataFlows": [
                                                                        {
                                                                            "streams": [
                                                                                "Microsoft-SecurityEvent"
                                                                            ],
                                                                            "destinations": [
                                                                                "DataCollectionEvent"
                                                                            ]
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                },
                                                "dependsOn": [
                                                    "[[resourceId('Microsoft.Resources/resourceGroups', parameters('dcrResourceGroup'))]"
                                                ]
                                            },
                                            {
                                                "type": "Microsoft.Resources/deployments",
                                                "name": "[[variables('deployDataCollectionRulesAssociation')]",
                                                "apiVersion": "2020-06-01",
                                                "resourceGroup": "[[parameters('resourceGroup')]",
                                                "dependsOn": [
                                                    "[[variables('deployDefaultAmaDcrResourceGroup')]"
                                                ],
                                                "properties": {
                                                    "mode": "Incremental",
                                                    "expressionEvaluationOptions": {
                                                        "scope": "inner"
                                                    },
                                                    "parameters": {
                                                        "vmName": {
                                                            "value": "[[parameters('vmName')]"
                                                        },
                                                        "dcrId": {
                                                            "value": "[[variables('dcrId')]"
                                                        },
                                                        "dcraName": {
                                                            "value": "[[variables('dcraName')]"
                                                        }
                                                    },
                                                    "template": {
                                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                        "contentVersion": "1.0.0.0",
                                                        "parameters": {
                                                            "vmName": {
                                                                "type": "string"
                                                            },
                                                            "dcrId": {
                                                                "type": "string"
                                                            },
                                                            "dcraName": {
                                                                "type": "string"
                                                            }
                                                        },
                                                        "variables": {},
                                                        "resources": [
                                                            {
                                                                "type": "Microsoft.Compute/virtualMachines/providers/dataCollectionRuleAssociations",
                                                                "name": "[[parameters('dcraName')]",
                                                                "apiVersion": "2021-04-01",
                                                                "properties": {
                                                                    "description": "Association of data collection rule for Microsoft Defender for Cloud. Deleting this association will break the collection of Security Events for this virtual machine.",
                                                                    "dataCollectionRuleId": "[[parameters('dcrId')]"
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2021-06-01",
            "name": "[variables('dcraPolicyDefinitionName')]",
            "properties": {
                "policyType": "Custom",
                "mode": "Indexed",
                "displayName": "[variables('dcraPolicyDefinitionDisplayName')]",
                "description": "[variables('dcraPolicyDefinitionDescription')]",
                "metadata": {
                    "category": "Security Center"
                },
                "parameters": {
                    "effect": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Effect",
                            "description": "Enable or disable the execution of the policy"
                        },
                        "allowedValues": [
                            "DeployIfNotExists",
                            "Disabled"
                        ],
                        "defaultValue": "DeployIfNotExists"
                    },
                    "dcrResourceGroup": {
                        "type": "String",
                        "metadata": {
                            "displayName": "DCR Resource Group",
                            "description": "Resource Group for the Security Events Data Collection Rule"
                        }
                    },
                    "dcrRegion": {
                        "type": "String",
                        "metadata": {
                            "displayName": "DCR region",
                            "description": "Region from which the virtual machines in scope will send their logs. Needed to create the Data Collection Rule in the same region",
                            "strongType": "location"
                        }
                    },
                    "listOfWindowsImageIdToInclude": {
                        "type": "Array",
                        "metadata": {
                            "displayName": "Additional Virtual Machine Images",
                            "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
                        },
                        "defaultValue": []
                    }
                },
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Compute/virtualMachines"
                            },
                            {
                                "field": "location",
                                "in": [
                                    "australiacentral",
                                    "australiaeast",
                                    "australiasoutheast",
                                    "brazilsouth",
                                    "canadacentral",
                                    "canadaeast",
                                    "centralindia",
                                    "centralus",
                                    "eastasia",
                                    "eastus2euap",
                                    "eastus",
                                    "eastus2",
                                    "francecentral",
                                    "germanywestcentral",
                                    "japaneast",
                                    "japanwest",
                                    "jioindiawest",
                                    "koreacentral",
                                    "koreasouth",
                                    "northcentralus",
                                    "northeurope",
                                    "norwayeast",
                                    "southafricanorth",
                                    "southcentralus",
                                    "southeastasia",
                                    "southindia",
                                    "switzerlandnorth",
                                    "uaenorth",
                                    "uksouth",
                                    "ukwest",
                                    "westcentralus",
                                    "westeurope",
                                    "westindia",
                                    "westus",
                                    "westus2"
                                ]
                            },
                            {
                                "anyOf": [
                                    {
                                        "field": "Microsoft.Compute/imageId",
                                        "in": "[[parameters('listOfWindowsImageIdToInclude')]"
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsServer"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "WindowsServer"
                                            },
                                            {
                                                "anyOf": [
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2008-R2-SP1*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2012-*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2016-*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2019-*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageSku",
                                                        "like": "2022-*"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsServer"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "WindowsServerSemiAnnual"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageSKU",
                                                "in": [
                                                    "Datacenter-Core-1709-smalldisk",
                                                    "Datacenter-Core-1709-with-Containers-smalldisk",
                                                    "Datacenter-Core-1803-with-Containers-smalldisk"
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsServerHPCPack"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "WindowsServerHPCPack"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftSQLServer"
                                            },
                                            {
                                                "anyOf": [
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2022"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2022-BYOL"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2019"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2019-BYOL"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2016"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2016-BYOL"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2012R2"
                                                    },
                                                    {
                                                        "field": "Microsoft.Compute/imageOffer",
                                                        "like": "*-WS2012R2-BYOL"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftRServer"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "MLServer-WS2016"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftVisualStudio"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "in": [
                                                    "VisualStudio",
                                                    "Windows"
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftDynamicsAX"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "Dynamics"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageSKU",
                                                "equals": "Pre-Req-AX7-Onebox-U8"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "microsoft-ads"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "windows-data-science-vm"
                                            }
                                        ]
                                    },
                                    {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Compute/imagePublisher",
                                                "equals": "MicrosoftWindowsDesktop"
                                            },
                                            {
                                                "field": "Microsoft.Compute/imageOffer",
                                                "equals": "Windows-10"
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    "then": {
                        "effect": "[[parameters('effect')]",
                        "details": {
                            "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                            "name": "SecurityEvents-RulesAssociation",
                            "roleDefinitionIds": [
                                "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
                                "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
                            ],
                            "deployment": {
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {
                                        "resourceGroup": {
                                            "value": "[[resourceGroup().name]"
                                        },
                                        "vmName": {
                                            "value": "[[field('name')]"
                                        },
                                        "dcrResourceGroup": {
                                            "value": "[[parameters('dcrResourceGroup')]"
                                        },
                                        "dcrRegion": {
                                            "value": "[[parameters('dcrRegion')]"
                                        }
                                    },
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "resourceGroup": {
                                                "type": "string"
                                            },
                                            "vmName": {
                                                "type": "string"
                                            },
                                            "dcrResourceGroup": {
                                                "type": "string"
                                            },
                                            "dcrRegion": {
                                                "type": "string"
                                            }
                                        },
                                        "variables": {
                                            "subscriptionId": "[[subscription().subscriptionId]",
                                            "dcrName": "[[concat('Microsoft-SecurityEvents-', parameters('dcrRegion'), '-dcr')]",
                                            "dcrId": "[[concat('/subscriptions/', variables('subscriptionId'), '/resourceGroups/', parameters('dcrResourceGroup'), '/providers/Microsoft.Insights/dataCollectionRules/', variables('dcrName'))]",
                                            "dcraName": "[[concat(parameters('vmName'),'/Microsoft.Insights/SecurityEvents-RulesAssociation')]"
                                        },
                                        "resources": [
                                            {
                                                "type": "Microsoft.Compute/virtualMachines/providers/dataCollectionRuleAssociations",
                                                "name": "[[variables('dcraName')]",
                                                "apiVersion": "2021-04-01",
                                                "properties": {
                                                    "description": "Association of data collection rule for Microsoft Defender for Cloud. Deleting this association will break the detection of security vulnerabilities for this virtual machine.",
                                                    "dataCollectionRuleId": "[[variables('dcrId')]"
                                                }
                                            }
                                        ]
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policySetDefinitions",
            "apiVersion": "2021-06-01",
            "name": "[variables('policySetName')]",
            "dependsOn" : [
                "[resourceId('Microsoft.Authorization/policyDefinitions', variables('dcrPolicyDefinitionName'))]",
                "[resourceId('Microsoft.Authorization/policyDefinitions', variables('dcraPolicyDefinitionName'))]"
            ],
            "properties": {
                "displayName": "[variables('policySetDisplayName')]",
                "description": "[variables('policySetDescription')]",
                "policyType": "Custom",
                "metadata": {
                    "category": "Security Center"
                },
                "parameters": {
                    "effect": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Effect",
                            "description": "Enable or disable the execution of the policy"
                        },
                        "allowedValues": [
                            "DeployIfNotExists",
                            "Disabled"
                        ],
                        "defaultValue": "DeployIfNotExists"
                    },
                    "userWorkspaceResourceId": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Workspace Resource Id",
                            "description": "Select the Log Analytics workspace to which the virtual machines in scope will send their logs. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                            "strongType": "omsWorkspace"
                        }
                    },
                    "dcrRegion": {
                        "type": "String",
                        "metadata": {
                            "displayName": "DCR region",
                            "description": "Region from which the virtual machines in scope will send their logs. Needed to create the Data Collection Rule in the same region",
                            "strongType": "location"
                        }
                    },
                    "dcrResourceGroup": {
                        "type": "String",
                        "metadata": {
                            "displayName": "DCR Resource Group",
                            "description": "Resource Group for the Security Events Data Collection Rule"
                        }
                    },
                    "eventFilter": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Security Events Filter",
                            "description": "Security Events Filter (all events, common, minimal, or custom)"
                        },
                        "allowedValues": [ "AllEvents", "Common", "Minimal", "Custom" ]
                    },
                    "listOfCustomEventFilters": {
                        "type": "Array",
                        "metadata": {
                            "displayName": "Custom xPath Queries",
                            "description": "List of xPath queries to filter the Security Events. Example values: 'Security!*[System[(EventID=4624 or EventID=4625)]]'"
                        },
                        "defaultValue": []
                    },
                    "listOfWindowsImageIdToInclude": {
                        "type": "Array",
                        "metadata": {
                            "displayName": "Additional Virtual Machine Images",
                            "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
                        },
                        "defaultValue": []
                    }
                },
                "policyDefinitions": [
                    {
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/', variables('dcrPolicyDefinitionName'))]",
                        "policyDefinitionReferenceId": "[variables('dcrPolicyDefinitionName')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('effect')]"
                            },
                            "userWorkspaceResourceId": {
                                "value": "[[parameters('userWorkspaceResourceId')]"
                            },
                            "dcrRegion": {
                                "value": "[[parameters('dcrRegion')]"
                            },
                            "dcrResourceGroup": {
                                "value": "[[parameters('dcrResourceGroup')]"
                            },
                            "eventFilter": {
                                "value": "[[parameters('eventFilter')]"
                            },
                            "listOfCustomEventFilters": {
                                "value": "[[parameters('listOfCustomEventFilters')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('listOfWindowsImageIdToInclude')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/', variables('dcraPolicyDefinitionName'))]",
                        "policyDefinitionReferenceId": "[variables('dcraPolicyDefinitionName')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('effect')]"
                            },
                            "dcrRegion": {
                                "value": "[[parameters('dcrRegion')]"
                            },
                            "dcrResourceGroup": {
                                "value": "[[parameters('dcrResourceGroup')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('listOfWindowsImageIdToInclude')]"
                            }
                        }
                    }
                ]
            }
        }
    ],
    "outputs": {}
}